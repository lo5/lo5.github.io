# Benchmarks (Write)

## Done

x WaveDB write concurrency tests

## Notes

### WaveDB benchmarks

WaveDB now has a `-benchmark` arg, which attempts to find out how many concurrent goroutines can read/write from/to a database table without failures. 

Each benchmark iteration doubles the number of concurrent goroutines until at least one encounters "failed to open database", after which the number of goroutines is dialed back until all goroutines succeed.

    func findConcurrency(ds *DS, b benchmark) (int, int) {
      trials := 0
      min, max, n := 0, 0, 1
      for {
        trials++
        if runBenchmark(ds, b, n) {
          min = n
          if max == 0 {
            n *= 2
            continue
          }
        } else {
          max = n
        }
        n = min + (max-min)/2
        if max-min <= 1 {
          break
        }
      }
      return n, trials
    }

#### Results:

    $ go run cmd/wavedb/main.go -benchmark
    benchmark: read1
      read1 (iteration 1/10, 20 trials): 1023 concurrent
      read1 (iteration 2/10, 24 trials): 3189 concurrent
      read1 (iteration 3/10, 24 trials): 3829 concurrent
      read1 (iteration 4/10, 24 trials): 3175 concurrent
      read1 (iteration 5/10, 26 trials): 4608 concurrent
      read1 (iteration 6/10, 24 trials): 3318 concurrent
      read1 (iteration 7/10, 26 trials): 4609 concurrent
      read1 (iteration 8/10, 26 trials): 4271 concurrent
      read1 (iteration 9/10, 24 trials): 3926 concurrent
      read1 (iteration 10/10, 22 trials): 2041 concurrent
    benchmark: read100
      read100 (iteration 1/10, 24 trials): 2453 concurrent
      read100 (iteration 2/10, 26 trials): 4104 concurrent
      read100 (iteration 3/10, 22 trials): 2047 concurrent
      read100 (iteration 4/10, 24 trials): 2472 concurrent
      read100 (iteration 5/10, 24 trials): 2572 concurrent
      read100 (iteration 6/10, 26 trials): 4096 concurrent
      read100 (iteration 7/10, 22 trials): 2035 concurrent
      read100 (iteration 8/10, 24 trials): 2424 concurrent
      read100 (iteration 9/10, 22 trials): 1981 concurrent
      read100 (iteration 10/10, 24 trials): 3163 concurrent
    benchmark: write1
      write1 (iteration 1/10, 20 trials): 526 concurrent
      write1 (iteration 2/10, 20 trials): 530 concurrent
      write1 (iteration 3/10, 20 trials): 527 concurrent
      write1 (iteration 4/10, 20 trials): 539 concurrent
      write1 (iteration 5/10, 20 trials): 542 concurrent
      write1 (iteration 6/10, 20 trials): 542 concurrent
      write1 (iteration 7/10, 20 trials): 535 concurrent
      write1 (iteration 8/10, 20 trials): 541 concurrent 
      write1 (iteration 9/10, 20 trials): 542 concurrent
      write1 (iteration 10/10, 20 trials): 537 concurrent
    benchmark: write10
      write10 (iteration 1/10, 20 trials): 536 concurrent
      write10 (iteration 2/10, 20 trials): 533 concurrent
      write10 (iteration 3/10, 20 trials): 527 concurrent
      write10 (iteration 4/10, 20 trials): 527 concurrent
      write10 (iteration 5/10, 18 trials): 479 concurrent
      write10 (iteration 6/10, 20 trials): 522 concurrent
      write10 (iteration 7/10, 20 trials): 537 concurrent
      write10 (iteration 8/10, 20 trials): 535 concurrent
      write10 (iteration 9/10, 20 trials): 540 concurrent
      write10 (iteration 10/10, 18 trials): 447 concurrent

    --- benchmark results ---
    read1 concurrency: min 1023, max 4609, avg 3662
    read100 concurrency: min 1981, max 4104, avg 2766
    write1 concurrency: min 526, max 542, avg 537
    write10 concurrency: min 447, max 540, avg 516


System (5yo Intel NUC):

    $ lscpu
    Architecture:                    x86_64
    CPU(s):                          8
    Thread(s) per core:              2
    Core(s) per socket:              4
    Socket(s):                       1
    Model name:                      Intel(R) Core(TM) i7-6770HQ CPU @ 2.60GHz
    ...

    $ sudo lshw -class disk -class storage
      *-nvme
           description: NVMe device
           product: Samsung SSD 960 EVO 250GB
    ...

    $ cat /proc/meminfo
    MemTotal:       32767132 kB
    ...


#### Results (Thinkpad P15):

    benchmark: read1
      read1 (iteration 1/10, 20 trials): 1023 concurrent
      read1 (iteration 2/10, 24 trials): 3083 concurrent
      read1 (iteration 3/10, 22 trials): 2035 concurrent
      read1 (iteration 4/10, 22 trials): 1783 concurrent
      read1 (iteration 5/10, 22 trials): 2035 concurrent
      read1 (iteration 6/10, 24 trials): 2558 concurrent
      read1 (iteration 7/10, 26 trials): 4096 concurrent
      read1 (iteration 8/10, 24 trials): 2515 concurrent
      read1 (iteration 9/10, 24 trials): 2641 concurrent
      read1 (iteration 10/10, 24 trials): 3073 concurrent
    benchmark: read100
      read100 (iteration 1/10, 22 trials): 1487 concurrent
      read100 (iteration 2/10, 22 trials): 1666 concurrent
      read100 (iteration 3/10, 22 trials): 1682 concurrent
      read100 (iteration 4/10, 22 trials): 1778 concurrent
      read100 (iteration 5/10, 22 trials): 1534 concurrent
      read100 (iteration 6/10, 20 trials): 1023 concurrent
      read100 (iteration 7/10, 22 trials): 1947 concurrent
      read100 (iteration 8/10, 22 trials): 1534 concurrent
      read100 (iteration 9/10, 22 trials): 1927 concurrent
      read100 (iteration 10/10, 22 trials): 1781 concurrent
    benchmark: write1
      write1 (iteration 1/10, 20 trials): 640 concurrent
      write1 (iteration 2/10, 20 trials): 635 concurrent
      write1 (iteration 3/10, 20 trials): 640 concurrent
      write1 (iteration 4/10, 18 trials): 447 concurrent
      write1 (iteration 5/10, 20 trials): 530 concurrent
      write1 (iteration 6/10, 20 trials): 532 concurrent
      write1 (iteration 7/10, 20 trials): 531 concurrent
      write1 (iteration 8/10, 18 trials): 431 concurrent
      write1 (iteration 9/10, 18 trials): 509 concurrent
      write1 (iteration 10/10, 20 trials): 527 concurrent
    benchmark: write10
      write10 (iteration 1/10, 20 trials): 531 concurrent
      write10 (iteration 2/10, 20 trials): 583 concurrent
      write10 (iteration 3/10, 18 trials): 479 concurrent
      write10 (iteration 4/10, 20 trials): 624 concurrent
      write10 (iteration 5/10, 18 trials): 495 concurrent
      write10 (iteration 6/10, 20 trials): 525 concurrent
      write10 (iteration 7/10, 20 trials): 533 concurrent
      write10 (iteration 8/10, 20 trials): 529 concurrent
      write10 (iteration 9/10, 18 trials): 508 concurrent
      write10 (iteration 10/10, 20 trials): 532 concurrent

    --- benchmark results ---
    read1 concurrency: min 1023, max 4096, avg 2646
    read100 concurrency: min 1023, max 1947, avg 1652
    write1 concurrency: min 431, max 640, avg 531
    write10 concurrency: min 479, max 624, avg 534

System:

    meh% lscpu
    Architecture:                    x86_64
    CPU(s):                          16
    Thread(s) per core:              2
    Core(s) per socket:              8
    Socket(s):                       1
    Model name:                      Intel(R) Core(TM) i7-10875H CPU @ 2.30GHz



    meh% sudo lshw -class disk -class storage
      *-storage
         *-nvme0
              description: NVMe device
              product: SKHynix_HFS256GD9TNI-L2B0B


    meh% cat /proc/meminfo
    MemTotal:       131536968 kB

